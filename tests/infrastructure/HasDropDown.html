<!DOCTYPE HTML>
<html>
<head>
	<title>HasDropDown unit test</title>

	<script type="text/javascript" src="../boilerplate.js"></script>

	<script type="text/javascript">
		require([
			"doh/runner",
			"dojo/keys", "dojo/on", "dojo/_base/window",
			"dui/register", "dui/HasDropDown", "dui/Widget",
			"dui/tests/helpers", "dojo/domReady!"
		], function (doh, keys, on, win, register, HasDropDown, Widget, helpers) {

			var SimplePopup = register("simple-popup", [HTMLElement, Widget], {
				// summary:
				//		A trivial popup widget
				label: "i'm a popup",
				_setLabelAttr: { type: "innerText" }
			});

			var SimpleDropDownButton = register("simple-drop-down-button", [HTMLButtonElement, Widget, HasDropDown], {

				// summary:
				//		A button that shows a popup.

				label: "show popup",
				_setLabelAttr: { type: "innerText" },

				popupLabel: "i'm a popup",
				orient: ["below"],

				postCreate: register.after(function () {
					this.dropDown = new SimplePopup({
						id: this.id + "_popup",
						label: this.popupLabel
					});
				})
			});

			var NonFocusableDropDownButton = register("non-focusable-drop-down-button", [HTMLElement, Widget, HasDropDown], {
				// summary:
				//		A non-focusable "button" that shows a popup.   Should work for mouse, although not for keyboard.

				label: "show popup (non-focusable)",
				_setLabelAttr: { type: "innerText" },

				orient: ["below"],

				postCreate: register.after(function () {
					this.dropDown = new SimplePopup({
						id: this.id + "_popup",
						label: "popup from non-focusable"
					});
				})
			});

			// Synthetic events.   Could alternately use robot.
			function key(node, key) {
				on.emit(node, "keydown", {
					keyCode: key,
					bubbles: true
				});
				on.emit(node, "keyup", {
					keyCode: key,
					bubbles: true
				});
			}

			function click(node) {
				on.emit(node, navigator.msPointerEnabled ? "MSPointerDown" : "mousedown", {
					button: 0,	// left button (except on IE quirks mode, when it's 1)
					bubbles: true
				});
				on.emit(node, navigator.msPointerEnabled ? "MSPointerUp" : "mouseup", {
					button: 0,	// left button (except on IE quirks mode, when it's 1)
					bubbles: true
				});
				on.emit(node, "click", {
					bubbles: true
				});
			}

			doh.register("basic", [
				function setup() {
					dd = new SimpleDropDownButton({id: "dd"}).placeAt(win.body());
					popup = dd.dropDown;
					doh.t(!!popup, "popup exists");
				},
				function open() {
					var d = new doh.Deferred();
					click(dd);
					setTimeout(d.getTestCallback(function () {
						doh.t(helpers.isVisible(popup), "popup visible");
					}), 10);
					return d;
				},
				function close() {
					dd.closeDropDown();
					doh.t(helpers.isHidden(popup), "popup hidden");
				},
				function openBySpace() {
					var d = new doh.Deferred();
					key(dd, keys.SPACE);
					setTimeout(d.getTestCallback(function () {
						doh.t(!!popup, "popup exists");
						doh.t(helpers.isVisible(popup), "popup visible again");
					}), 10);
					return d;
				},
				function close2() {
					dd.closeDropDown();
					doh.t(helpers.isHidden(popup), "popup hidden again");
				}
				// TODO: open by down arrow
			]);


			doh.register("non focusable", [
				function setup() {
					ndd = new NonFocusableDropDownButton({id: "ndd"}).placeAt(win.body());
					popup = ndd.dropDown;
					doh.t(!!popup, "popup exists");
				},
				function open() {
					var d = new doh.Deferred();
					click(ndd);
					setTimeout(d.getTestCallback(function () {
						doh.t(helpers.isVisible(popup), "popup visible");
					}), 10);
					return d;
				},
				function close() {
					ndd.closeDropDown();
				}
			]);

			doh.register("destroy", [
				function setup() {
					dd = new SimpleDropDownButton({id: "dd2"}).placeAt(win.body());
					popup = dd.dropDown;
					doh.t(!!popup, "popup exists");
				},
				function open() {
					var d = new doh.Deferred();
					click(dd);
					setTimeout(d.getTestCallback(function () {
						doh.t(helpers.isVisible(popup), "popup visible");
						doh.is(1, require("dui/popup")._stack.length, "in popup manager stack");
					}), 10);
					return d;
				},
				function destroy() {
					dd.destroy();
					doh.is(0, require("dui/popup")._stack.length, "popup was closed");
				}
			]);

			doh.run();
		});
	</script>
</head>
<body class="claro">
<h1>HasDropDown Unit Test</h1>
</body>
</html>
